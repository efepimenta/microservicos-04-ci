# steps:

#     - id: "rodando docker-compose"
#       name: 'gcr.io/$PROJECT_ID/docker-compose:1.24.0'
#       args: ['-f', 'docker-compose.yaml', 'up', '-d']

#     - id: "somando"
#       name: 'gcr.io/cloud-builders/docker'
#       args: ['exec', '-t', 'go-test', '/go/bin/soma']

#     - id: "rodando teste"
#       name: 'gcr.io/cloud-builders/docker'
#       args: ['exec', '-t', 'go-test', 'go', 'test', '-cover', './src/go-soma']

#     - name: 'gcr.io/cloud-builders/go'
#       args:
#       - 'build'
#       - 'version=1.0.0'
#       - '-t'
#       - 'gcr.io/$PROJECT_ID/go-test:latest'
#       - '-t'
#       - 'gcr.io/$PROJECT_ID/go-test:1.0.0'
#       - '.'
#     - name: 'gcr.io/$PROJECT_ID/go-test'
#       args: ['version']

# images:
# - 'gcr.io/$PROJECT_ID/go-test:latest'
# - 'gcr.io/$PROJECT_ID/go-test:1.0.0'

steps:
- name: 'gcr.io/$PROJECT_ID/docker-compose:1.24.0'
  args: ['-f', 'docker-compose.yaml', 'up', '-d']
- name: 'gcr.io/cloud-builders/go'
  args: ['test', 'go-soma']
  env: ['PROJECT_ROOT=go-soma', 'GOPATH=/go']
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '--tag=gcr.io/$PROJECT_ID/go-soma', '.']
images: ['gcr.io/$PROJECT_ID/go-soma']

# RUN go build -ldflags "-w" -o /go/bin/soma /go/src/go-soma/go-soma.go